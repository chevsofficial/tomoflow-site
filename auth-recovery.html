<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset your password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    /* Minimal page-specific styling */
    .center-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card-dark {
      background: #020617;
      color: #e5e7eb;
      padding: 32px;
      border-radius: 14px;
      width: 100%;
      max-width: 520px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .card-dark p { color: #cbd5f5; }

    .banner {
      display: none;
      margin: 14px 0 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(99, 102, 241, 0.14);
      border: 1px solid rgba(99, 102, 241, 0.35);
      color: #cbd5f5;
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
    }

    .form {
      margin-top: 18px;
      text-align: left;
    }
    .field {
      margin-bottom: 14px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: #cbd5f5;
    }
    input[type="password"] {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.6);
      color: #e5e7eb;
      outline: none;
      display: block; /* ensures global CSS can't hide it */
    }
    input[type="password"]::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }
    input[type="password"]:focus {
      border-color: rgba(99, 102, 241, 0.9);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 14px;
    }

    .btn-primary,
    .btn-secondary,
    .btn-deeplink {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1.2rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      color: #ffffff;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f97316, #ea580c);
    }
    .btn-primary:hover { filter: brightness(1.05); }

    .btn-deeplink {
      background: #6366f1;
    }
    .btn-deeplink:hover { filter: brightness(1.05); }

    .btn-secondary {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
    }

    .hint {
      margin-top: 14px;
      font-size: 13px;
      color: #94a3b8;
      word-break: break-word;
      text-align: left;
    }

    .status {
      margin-top: 14px;
      font-size: 14px;
      color: #cbd5f5;
      text-align: left;
      white-space: pre-wrap;
    }
    .error { color: #fca5a5; }
    .success { color: #86efac; }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="card-dark">
      <h1 id="title" style="margin-bottom: 12px; font-size: 26px;">Reset your password</h1>

      <p id="message" style="margin-bottom: 10px; font-size: 16px; line-height: 1.5;">
        Enter a new password below.
      </p>

      <!-- Mobile banner message -->
      <div class="banner" id="mobileBanner"></div>

      <!-- Mobile action row -->
      <div class="row" id="mobileRow" style="display:none;">
        <a class="btn-deeplink" id="openApp" href="tomoflow://auth-recovery">
          Open TomoFlow
        </a>
        <button class="btn-secondary" id="retryBtn" type="button">
          Try again
        </button>
      </div>

      <!-- Desktop reset form -->
      <form class="form" id="resetForm" style="display:none;">
        <div class="field">
          <label for="pw1">New password</label>
          <input id="pw1" type="password" autocomplete="new-password" placeholder="Enter new password" required />
        </div>

        <div class="field">
          <label for="pw2">Confirm password</label>
          <input id="pw2" type="password" autocomplete="new-password" placeholder="Confirm new password" required />
        </div>

        <div class="row">
          <button class="btn-primary" id="submitBtn" type="submit">
            Set new password
          </button>
        </div>

        <div class="status" id="status"></div>

        <noscript>
          <div class="status error">
            JavaScript is required to reset your password on the web. Please open TomoFlow.
          </div>
        </noscript>
      </form>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ✅ TODO: Replace with your real values (Supabase Project Settings → API)
    const SUPABASE_URL = "https://zkstcywertzzooxefwuh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inprc3RjeXdlcnR6em9veGVmd3VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTcwMjYsImV4cCI6MjA3OTc3MzAyNn0.ippeFJsR93VTUxgEA4wSrYxAlhKS4NzUPoDHd4VSbCk";

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Parse BOTH hash and query params (some clients strip hash or convert to query)
    function parseParams() {
      const hash = window.location.hash || "";
      const search = window.location.search || "";

      const hashParams = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
      const queryParams = new URLSearchParams(search.startsWith("?") ? search.slice(1) : search);

      const get = (k) => {
        const hv = hashParams.get(k);
        if (hv !== null && hv !== undefined && hv !== "") return hv;
        return queryParams.get(k);
      };

      return {
        hash,
        access_token: get("access_token"),
        refresh_token: get("refresh_token"),
        error_code: get("error_code"),
        error_description: get("error_description"),
      };
    }

    // Elements
    const titleEl = document.getElementById("title");
    const messageEl = document.getElementById("message");
    const hintEl = document.getElementById("hint");

    const formEl = document.getElementById("resetForm");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");

    const mobileBanner = document.getElementById("mobileBanner");
    const mobileRow = document.getElementById("mobileRow");
    const openAppEl = document.getElementById("openApp");
    const retryBtn = document.getElementById("retryBtn");

    // Visible fallback if anything breaks
    window.addEventListener("error", () => {
      if (statusEl) {
        statusEl.textContent = "This page failed to load the reset form. Please try again or open TomoFlow.";
        statusEl.className = "status error";
      }
    });

    const { hash, access_token, refresh_token, error_code, error_description } = parseParams();

    console.log("auth-recovery loaded", {
      access_token: !!access_token,
      refresh_token: !!refresh_token,
      error_code
    });

    // Deep link should preserve hash tokens so the app can complete recovery
    // If tokens are only in query, we still append the raw hash (if present).
    const deepLink = "tomoflow://auth-recovery" + (hash || "");
    if (openAppEl) openAppEl.setAttribute("href", deepLink);

    function setStatus(text, kind = "info") {
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.className =
        "status" + (kind === "error" ? " error" : kind === "success" ? " success" : "");
    }

    function showMobileHelperBanner(textHtml) {
      mobileBanner.style.display = "block";
      mobileBanner.innerHTML = textHtml;
      mobileRow.style.display = "flex";
    }

    function showExpiredUI(details = "") {
      titleEl.textContent = "Link expired ⏰";
      messageEl.innerHTML =
        "This password reset link is invalid, expired, or already used.<br/>" +
        "Please request a new reset email from TomoFlow.";
      hintEl.textContent = details || "";
      formEl.style.display = "none";

      if (isMobile()) {
        showMobileHelperBanner(
          "<strong>Password reset detected.</strong> If TomoFlow doesn’t open automatically, tap “Open TomoFlow” below."
        );
      } else {
        // Desktop: still show a gentle hint
        setStatus("Please request a new reset email from the app.", "error");
      }
    }

    // 1) If Supabase indicates expiration/invalid, show expired message and STOP.
    if (error_code) {
      const details = error_description ? decodeURIComponent(error_description) : "";
      showExpiredUI(details);
      return;
    }

    // 2) If missing tokens, show invalid/expired and STOP.
    if (!access_token || !refresh_token) {
      showExpiredUI("");
      return;
    }

    // 3) Mobile flow: show banner, attempt deep link, show button, STOP. Never show desktop form.
    if (isMobile()) {
      showMobileHelperBanner(
        "<strong>Password reset detected.</strong> Redirecting to the app…<br/>" +
        "If you are not automatically redirected, tap the button below to continue."
      );

      const attemptOpen = () => { window.location.href = deepLink; };

      // quick attempt + second attempt (sometimes helps)
      setTimeout(attemptOpen, 150);
      setTimeout(attemptOpen, 900);

      retryBtn.addEventListener("click", attemptOpen);

      // Hide form just in case
      formEl.style.display = "none";
      hintEl.textContent = "";
      return;
    }

    // 4) Desktop flow: show the form and perform password update on the web.
    formEl.style.display = "block";
    mobileRow.style.display = "none";
    mobileBanner.style.display = "none";
    hintEl.textContent = "";

    // Wrap the rest so any failure shows a visible fallback + Open App option
    try {
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function setSessionFromTokens() {
        const { error } = await supabase.auth.setSession({
          access_token,
          refresh_token,
        });
        if (error) throw error;
      }

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const pw1 = document.getElementById("pw1").value;
        const pw2 = document.getElementById("pw2").value;

        if (pw1.length < 8) {
          setStatus("Password must be at least 8 characters.", "error");
          return;
        }
        if (pw1 !== pw2) {
          setStatus("Passwords do not match.", "error");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Updating…";
        setStatus("Setting session…");

        try {
          await setSessionFromTokens();
          setStatus("Updating password…");

          const { error } = await supabase.auth.updateUser({ password: pw1 });
          if (error) throw error;

          titleEl.textContent = "Password updated ✅";
          messageEl.innerHTML = "Your password has been successfully updated.<br/>You can now sign in.";
          formEl.style.display = "none";
          setStatus("", "success");

          // Remove tokens from the URL
          history.replaceState(null, "", "/auth-recovery");

        } catch (err) {
          const msg = (err && err.message) ? err.message : "Something went wrong. Please request a new reset email.";
          setStatus(msg, "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Set new password";
        }
      });

    } catch (err) {
      // If module/CDN/csp breaks, show fallback and Open App
      formEl.style.display = "none";
      showMobileHelperBanner("Unable to load the reset form. Please open TomoFlow to reset your password.");
      hintEl.textContent = String((err && err.message) ? err.message : err);
      return;
    }
  </script>

</body>
</html>
