<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset your password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    /* Small page-specific helpers (still minimal, uses your global CSS base) */
    .center-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card-dark {
      background: #020617;
      color: #e5e7eb;
      padding: 32px;
      border-radius: 14px;
      width: 100%;
      max-width: 520px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .card-dark p {
      color: #cbd5f5;
    }
    .btn-deeplink {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1.2rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #ffffff;
    }
    .btn-deeplink:hover {
      filter: brightness(1.05);
    }
    .hint {
      margin-top: 14px;
      font-size: 13px;
      color: #94a3b8;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="card-dark">
      <h1 id="title" style="margin-bottom: 12px; font-size: 26px;">Reset your password</h1>

      <p id="message" style="margin-bottom: 24px; font-size: 16px; line-height: 1.5;">
        To finish resetting your password, return to the TomoFlow app.
      </p>

      <!-- This link will be updated to include the hash tokens -->
      <a class="btn-deeplink" id="openApp" href="tomoflow://auth-recovery">
        Open TomoFlow
      </a>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <script>
    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Supabase sends tokens in the URL hash (#access_token=... etc).
    // Preserve them by forwarding into the custom scheme deep link.
    const hash = window.location.hash || "";
    const deepLink = "tomoflow://auth-recovery" + hash;

    const openAppEl = document.getElementById("openApp");
    openAppEl.setAttribute("href", deepLink);

    // Parse hash params for possible errors (expired link, already used, etc.)
    const params = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
    const errorCode = params.get("error_code");
    const errorDesc = params.get("error_description");

    const titleEl = document.getElementById("title");
    const messageEl = document.getElementById("message");
    const hintEl = document.getElementById("hint");

    if (errorCode) {
      titleEl.textContent = "Link expired ‚è∞";
      messageEl.innerHTML =
        "This password reset link is invalid, expired, or already used.<br/>" +
        "Return to TomoFlow and request a new reset email.";

      hintEl.textContent = errorDesc ? decodeURIComponent(errorDesc) : "";
    } else {
      hintEl.textContent = "";

      // Optional: auto-attempt opening the app on mobile
      if (isMobile()) {
        setTimeout(() => {
          window.location.href = deepLink;
        }, 600);
      }
    }
  </script>

</body>
</html>
