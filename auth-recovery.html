<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset your password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared site styles -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    .center-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card-dark {
      background: #020617;
      color: #e5e7eb;
      padding: 32px;
      border-radius: 14px;
      width: 100%;
      max-width: 520px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }

    .card-dark p { color: #cbd5f5; }

    .banner {
      display: none;
      margin: 14px 0 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(99, 102, 241, 0.14);
      border: 1px solid rgba(99, 102, 241, 0.35);
      color: #cbd5f5;
      text-align: center;
      font-size: 14px;
      line-height: 1.4;
    }

    .form {
      margin-top: 18px;
      text-align: left;
    }

    .field { margin-bottom: 14px; }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: #cbd5f5;
    }

    .pw-wrap { position: relative; }

    input[type="password"],
    input[type="text"].pw-input {
      width: 100%;
      padding: 12px 44px 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.6);
      color: #e5e7eb;
      outline: none;
      display: block;
      box-sizing: border-box;
    }

    input::placeholder { color: rgba(148, 163, 184, 0.8); }

    input:focus {
      border-color: rgba(99, 102, 241, 0.9);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }

    .pw-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      padding: 6px;
      cursor: pointer;
      line-height: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pw-toggle img {
      width: 22px;
      height: 22px;
      display: block;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 14px;
    }

    .btn-primary,
    .btn-secondary,
    .btn-deeplink {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1.2rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      color: #ffffff;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary { background: linear-gradient(135deg, #f97316, #ea580c); }
    .btn-primary:hover { filter: brightness(1.05); }

    .btn-deeplink { background: #6366f1; }
    .btn-deeplink:hover { filter: brightness(1.05); }

    .btn-secondary {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
    }

    .hint {
      margin-top: 14px;
      font-size: 13px;
      color: #94a3b8;
      word-break: break-word;
      text-align: center;
    }

    .status {
      margin-top: 14px;
      font-size: 14px;
      color: #cbd5f5;
      text-align: center;
      white-space: pre-wrap;
    }

    .error { color: #fca5a5; }
    .success { color: #86efac; }
  </style>
</head>
<body>

  <div class="center-wrap">
    <div class="card-dark">
      <h1 id="title" style="margin-bottom: 12px; font-size: 26px;">Reset your password</h1>

      <p id="message" style="margin-bottom: 10px; font-size: 16px; line-height: 1.5;">
        Enter a new password below.
      </p>

      <!-- Mobile banner -->
      <div class="banner" id="mobileBanner"></div>

      <!-- Mobile actions -->
      <div class="row" id="mobileRow" style="display:none;">
        <a class="btn-deeplink" id="openApp" href="tomoflow:///auth-recovery">
          Open TomoFlow
        </a>
        <button class="btn-secondary" id="retryBtn" type="button">Try again</button>
      </div>

      <!-- Desktop form -->
      <form class="form" id="resetForm" style="display:none;">
        <div class="field">
          <label for="pw1">New password</label>
          <div class="pw-wrap">
            <input id="pw1" class="pw-input" type="password" autocomplete="new-password" placeholder="Enter new password" required />
            <button type="button" class="pw-toggle" id="togglePw1" aria-label="Show password">
              <img id="togglePw1Icon" src="/assets/img/icons/tomato-show.png" alt="" />
            </button>
          </div>
        </div>

        <div class="field">
          <label for="pw2">Confirm password</label>
          <div class="pw-wrap">
            <input id="pw2" class="pw-input" type="password" autocomplete="new-password" placeholder="Confirm new password" required />
            <button type="button" class="pw-toggle" id="togglePw2" aria-label="Show password">
              <img id="togglePw2Icon" src="/assets/img/icons/tomato-show.png" alt="" />
            </button>
          </div>
        </div>

        <div class="row">
          <button class="btn-primary" id="submitBtn" type="submit">
            Set new password
          </button>
        </div>

        <div class="status" id="status"></div>

        <noscript>
          <div class="status error">
            JavaScript is required to reset your password on the web. Please open TomoFlow.
          </div>
        </noscript>
      </form>

      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- UMD build of supabase-js (no ES modules) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    const SUPABASE_URL = "https://zkstcywertzzooxefwuh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inprc3RjeXdlcnR6em9veGVmd3VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTcwMjYsImV4cCI6MjA3OTc3MzAyNn0.ippeFJsR93VTUxgEA4wSrYxAlhKS4NzUPoDHd4VSbCk";

    const TOMATO_SHOW = "/assets/img/icons/tomato-show.png";
    const TOMATO_HIDE = "/assets/img/icons/tomato-hide.png";

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function parseParams() {
      const hash = window.location.hash || "";
      const search = window.location.search || "";

      const hashParams = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
      const queryParams = new URLSearchParams(search.startsWith("?") ? search.slice(1) : search);

      const get = (k) => {
        const hv = hashParams.get(k);
        return (hv !== null && hv !== undefined) ? hv : queryParams.get(k);
      };

      return {
        hash,
        search,
        access_token: get("access_token"),
        refresh_token: get("refresh_token"),
        error_code: get("error_code"),
        error_description: get("error_description"),
      };
    }

    function getCodeParam() {
      const qp = new URLSearchParams(window.location.search || "");
      return qp.get("code");
    }

    const titleEl = document.getElementById("title");
    const messageEl = document.getElementById("message");
    const hintEl = document.getElementById("hint");

    const formEl = document.getElementById("resetForm");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");

    const mobileBanner = document.getElementById("mobileBanner");
    const mobileRow = document.getElementById("mobileRow");
    const openAppEl = document.getElementById("openApp");
    const retryBtn = document.getElementById("retryBtn");

    function setStatus(text, kind) {
      if (!statusEl) return;
      statusEl.textContent = text || "";
      statusEl.className =
        "status" + (kind === "error" ? " error" : kind === "success" ? " success" : "");
    }

    function showMobileBanner(html) {
      mobileBanner.style.display = "block";
      mobileBanner.innerHTML = html;
      mobileRow.style.display = "flex";
    }

    // UPDATED: expired mobile copy + remove "Try again" + open
